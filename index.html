<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>VR Room with Collision Tracking</title>
  <meta name="description" content="VR Room with Table and Mirror">
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.0.0/dist/aframe-extras.min.js"></script>
</head>
<body>
  <a-scene>
    <!-- Camera rig for player movement -->
    <a-entity id="rig" movement-controls="fly: false; speed: 0.15">
      <a-entity id="camera" camera position="0 1.6 0" look-controls="pointerLockEnabled: false"></a-entity>
      
      <!-- VR Controllers -->
      <a-entity oculus-touch-controls="hand: left"></a-entity>
      <a-entity oculus-touch-controls="hand: right"></a-entity>
    </a-entity>

    <!-- Room Walls (12ft x 12ft x 8ft) -->
    <!-- 1 foot ‚âà 0.3048 meters: 12ft = 3.658m, 8ft = 2.438m -->
    
    <!-- Floor -->
    <a-plane position="0 0 0" rotation="-90 0 0" width="3.658" height="3.658" color="#666666" shadow></a-plane>
    
    <!-- Ceiling -->
    <a-plane position="0 2.438 0" rotation="90 0 0" width="3.658" height="3.658" color="#666666"></a-plane>
    
    <!-- Back Wall (with mirror) -->
    <a-box id="back-wall" position="0 1.219 -1.829" width="3.658" height="2.438" depth="0.1" color="#666666"></a-box>
    
    <!-- Mirror frame (outer border) - in front of wall -->
    <a-box position="0 1.219 -1.774" width="3.2" height="2.0" depth="0.08" color="#1a1a1a" material="metalness: 0.9; roughness: 0.2"></a-box>
    
    <!-- Mirror surface (10ft x 6ft = 3.048m x 1.829m) - in front of frame -->
    <a-plane 
      id="mirror"
      position="0 1.219 -1.73" 
      width="3.048" 
      height="1.829" 
      material="shader: standard; metalness: 1; roughness: 0; color: #FFFFFF; emissive: #888888; emissiveIntensity: 0.3; side: double">
    </a-plane>
    
    <!-- Front Wall -->
    <a-box position="0 1.219 1.829" width="3.658" height="2.438" depth="0.1" color="#666666"></a-box>
    
    <!-- Left Wall -->
    <a-box position="-1.829 1.219 0" width="0.1" height="2.438" depth="3.658" color="#666666"></a-box>
    
    <!-- Right Wall -->
    <a-box position="1.829 1.219 0" width="0.1" height="2.438" depth="3.658" color="#666666"></a-box>

    <!-- Table in center (3ft x 3ft x 3ft = 0.914m) -->
    <!-- Table top -->
    <a-box 
      id="collision-table"
      position="0 0.864 0" 
      width="0.914" 
      height="0.05" 
      depth="0.914" 
      color="#8B4513">
    </a-box>
    
    <!-- Table legs (each leg is 5cm x 5cm x 0.864m tall) -->
    <!-- Front-left leg -->
    <a-box position="-0.382 0.432 0.382" width="0.05" height="0.864" depth="0.05" color="#654321"></a-box>
    <!-- Front-right leg -->
    <a-box position="0.382 0.432 0.382" width="0.05" height="0.864" depth="0.05" color="#654321"></a-box>
    <!-- Back-left leg -->
    <a-box position="-0.382 0.432 -0.382" width="0.05" height="0.864" depth="0.05" color="#654321"></a-box>
    <!-- Back-right leg -->
    <a-box position="0.382 0.432 -0.382" width="0.05" height="0.864" depth="0.05" color="#654321"></a-box>

    <!-- Lighting -->
    <a-light type="ambient" color="#BBB" intensity="0.8"></a-light>
    <a-light type="directional" color="#FFF" intensity="0.6" position="2 4 1"></a-light>
    <a-light type="point" color="#FFF" intensity="0.5" position="0 2 0"></a-light>
  </a-scene>

  <script>
    // Configuration - UPDATE THIS WITH YOUR VERCEL FUNCTION URL
    const VERCEL_API_URL = 'https://vr-collision-tracker-436c.vercel.app/api/log-collision';
    
    // Session management
    let sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    let collisionCount = 0;
    let totalCollisions = 0;
    let isColliding = false;
    let lastCollisionTime = 0;

    // Wait for scene to load
    document.addEventListener('DOMContentLoaded', function() {
      const scene = document.querySelector('a-scene');
      
      scene.addEventListener('loaded', function() {
        console.log('VR Scene loaded successfully');
        console.log('Session ID:', sessionId);
        console.log('Vercel API URL:', VERCEL_API_URL);
        
        // Start collision detection
        startCollisionDetection();
      });
    });

    function startCollisionDetection() {
      const rig = document.querySelector('#rig');
      const table = document.querySelector('#collision-table');
      
      if (!rig || !table) {
        console.error('Rig or table not found!');
        return;
      }
      
      console.log('Collision detection started');
      
      // Check for collisions every frame
      setInterval(function() {
        checkCollision(rig, table);
      }, 100); // Check every 100ms
    }

    function checkCollision(rig, table) {
      const rigPos = rig.getAttribute('position');
      const tablePos = table.getAttribute('position');
      
      // Player collision box (cylindrical approximation)
      const playerRadius = 0.4; // 40cm radius around player
      const playerHeight = 1.8; // 1.8m tall
      
      // Table dimensions - now checking for table top
      const tableHalfWidth = 0.457; // Half of 0.914m
      const tableTop = 0.864; // Height of table top
      
      // Check if player is within table bounds
      const dx = Math.abs(rigPos.x - tablePos.x);
      const dz = Math.abs(rigPos.z - tablePos.z);
      
      // Simple collision detection - check if player hits table or legs
      const collision = (
        dx < (playerRadius + tableHalfWidth) &&
        dz < (playerRadius + tableHalfWidth) &&
        rigPos.y < (tableTop + 0.1) &&
        rigPos.y + playerHeight > 0
      );
      
      // Debounce - only log if at least 1 second has passed since last collision
      const currentTime = Date.now();
      
      if (collision && !isColliding && (currentTime - lastCollisionTime > 1000)) {
        isColliding = true;
        lastCollisionTime = currentTime;
        logCollision();
      } else if (!collision) {
        isColliding = false;
      }
    }

    function logCollision() {
      collisionCount++;
      totalCollisions++;
      
      console.log('üéØ COLLISION DETECTED!');
      console.log('Collision Count:', collisionCount);
      console.log('Total Collisions:', totalCollisions);
      
      const data = {
        sessionId: sessionId,
        collisionCount: collisionCount,
        totalCollisions: totalCollisions
      };
      
      console.log('Sending to backend:', data);
      
      // Send to backend
      fetch(VERCEL_API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      })
      .then(response => {
        console.log('Response status:', response.status);
        return response.json();
      })
      .then(data => {
        console.log('‚úÖ Collision logged to Google Sheets:', data);
      })
      .catch(error => {
        console.error('‚ùå Error logging collision:', error);
      });
    }
  </script>
</body>
</html>